upstream frontend_upstream {
    server frontend:8100;
}

upstream backend_upstream {
    server backend:8000;
}

upstream mcp_upstream {
    server mcp:8200;
}

# Unified Server Block (haebo.pro)
server {
    listen 80;
    server_name haebo.pro www.haebo.pro localhost;

    # 1. Frontend (Root)
    location / {
        proxy_pass http://frontend_upstream;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 2. Frontend Streamlit WebSocket
    location /_stcore/stream {
        proxy_pass http://frontend_upstream/_stcore/stream;
        proxy_http_version 1.1;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header Host $host;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_read_timeout 86400;
    }

    # 3. Backend API (Optional, if needed)
    location /api {
        proxy_pass http://backend_upstream;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # 4. MCP Server Endpoints (Subpath Strategy)
    # http://haebo.pro/mcp -> MCP Server (Rewritten to internal /sse)
    location /mcp {
        proxy_pass http://mcp_upstream/sse; 
        proxy_http_version 1.1;
        proxy_set_header Connection ""; # Keep-alive for SSE
        
        # Critical: Trick Uvicorn into thinking it is accessed locally
        proxy_set_header Host localhost; 
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3600s;
    }

    # http://haebo.pro/messages -> MCP Server
    location /messages {
        proxy_pass http://mcp_upstream; # Path is preserved (/messages)
        proxy_http_version 1.1;
        
        # Critical: Trick Uvicorn into thinking it is accessed locally
        proxy_set_header Host localhost;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
